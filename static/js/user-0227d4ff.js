import{d as e,i as t,u as a,r as l,e as n,f as s}from"./index-8ab01e20.js";import"./vue-echarts-f79e68f9.js";import{a as o,b as r}from"./element-plus-ad41b746.js";import"./store-96e17a43.js";import{u as i}from"./index-98f4437c.js";import{d,p as u,e as p,R as c,o as m,c as v,b as f,y as b,Y as y,a as h,J as g,M as k,K as _,N as x,I as w,al as j,ak as C,q as I,V as S,F as V}from"./@vue.runtime-core-e50a2272.js";import{e as N,u as W,h as U}from"./@vue.reactivity-da630c06.js";import{_ as z}from"./_plugin-vue_export-helper-c4cb8a60.js";import{v as q,w as L}from"./@vue.runtime-dom-90e9fdb1.js";import{Q as R,R as A,E as M}from"./@element-plus.icons-vue-26cbeb7a.js";import{j as T}from"./lodash-es-a085e596.js";import{o as $,L as B}from"./@vue.shared-5670d8a7.js";import"./axios-966d6f38.js";import"./nprogress-6d1393d1.js";import"./vue-router-916993ce.js";import"./pinia-bb8d2f73.js";import"./vue-demi-5b9a0fa5.js";import"./@vueuse.core-2fa6d9e6.js";import"./@vueuse.shared-ca6b0f06.js";import"./vue-b5fce9d1.js";import"./mockjs-93ca2bc8.js";import"./mitt-dab1f1cb.js";import"./@popperjs.core-040feab9.js";import"./@ctrl.tinycolor-84ad98d6.js";import"./dayjs-dd470533.js";import"./async-validator-efc2d198.js";import"./memoize-one-99e54574.js";import"./escape-html-4bbaf1e1.js";import"./normalize-wheel-es-da779ce4.js";import"./@floating-ui.dom-9d85c32a.js";import"./@floating-ui.core-c56fb7e8.js";import"./resize-detector-94afada7.js";import"./echarts-6943293a.js";import"./tslib-ed971494.js";import"./zrender-0d232395.js";const F={class:"dept-select"},E=d({name:"dept-select"}),G=z(d({...E,props:{modelValue:[Array,Number,String],multiple:Boolean,checkStrictly:{type:Boolean,default:!0}},emits:["update:modelValue","change"],setup(t,{emit:a}){const l=t,{service:n}=i(),s=N(),r=N();function d(e){l.multiple||a("update:modelValue",e)}function b(e,{checkedKeys:t}){l.multiple&&a("update:modelValue",t)}return u((()=>l.modelValue),(e=>{s.value=e}),{immediate:!0}),p((()=>{n.base.sys.department.list().then((t=>{r.value=e(t)})).catch((e=>{r.value=[],o.error(e.message)}))})),(e,a)=>{const l=c("el-tree-select");return m(),v("div",F,[f(l,{modelValue:s.value,"onUpdate:modelValue":a[0]||(a[0]=e=>s.value=e),"node-key":"id",data:r.value,props:{label:"name",value:"id",children:"children"},multiple:t.multiple,"check-strictly":t.checkStrictly,"show-checkbox":t.multiple,"default-expand-all":"",onChange:d,onCheck:b},null,8,["modelValue","data","multiple","check-strictly","show-checkbox"])])}}}),[["__scopeId","data-v-6be59c9b"]]),K={class:"dept-move"},J=d({name:"dept-move"}),Q=d({...J,setup(e,{expose:a}){const{service:l}=i(),n=t.exports.useForm(),s=t.exports.useCrud();return a({open:async function(e){var t;null==(t=n.value)||t.open({title:"部門轉移",width:"600px",props:{labelWidth:"80px"},items:[{label:"選擇部門",prop:"departmentId",component:{vm:G}}],on:{submit(t,{done:a,close:n}){if(!t.departmentId)return o.warning("請選擇部門"),a();r.confirm("是否轉移部門？","提示",{type:"warning"}).then((()=>{l.base.sys.user.move({...t,userIds:e}).then((()=>{var e;o.success("轉移成功"),null==(e=s.value)||e.refresh(),n()})).catch((e=>{o.error(e.message),a()}))})).catch((()=>null))}}})}}),(e,t)=>{const a=c("cl-form");return m(),v("div",K,[f(a,{ref_key:"Form",ref:n},null,512)])}}}),Y={class:"dept-tree"},D={class:"dept-tree__header"},H=(e=>(j("data-v-87c6d1b5"),e=e(),C(),e))((()=>h("div",null,"組織架構",-1))),O={class:"dept-tree__op"},P={class:"no"},X=["onContextmenu"],Z={class:"dept-tree__node"},ee=["onClick"],te=["onClick"],ae=d({name:"dept-tree"}),le=z(d({...ae,props:{drag:{type:Boolean,default:!0},level:{type:Number,default:99}},emits:["list-change","row-click","user-add"],setup(s,{emit:d}){const u=s,{service:j}=i(),{app:C}=a(),I=N([]),S=N(),V=N(!1),U=N(!1),z=t.exports.useForm(),F=b("viewGroup");function E({data:e}){return e.parentId}function G(e,t){return t.data.parentId}async function K(){V.value=!0,U.value=!1,await j.base.sys.department.list().then((t=>{I.value=e(t),S.value||(S.value=I.value[0]),J(S.value)})),V.value=!1}function J(e){if(e){const t=e.children?l(e.children).map((e=>e.id)):[];t.unshift(e.id),S.value=e,F.checkExpand(!1),d("row-click",{item:e,ids:t})}}function Q(e){var t;const a=e.id?"update":"add";null==(t=z.value)||t.open({title:"編輯部門",width:"550px",props:{labelWidth:"100px"},items:[{label:"部門名稱",prop:"name",component:{name:"el-input"},required:!0},{label:"上級部門",prop:"parentName",component:{name:"el-input",props:{disabled:!0}}},{label:"排序",prop:"orderNum",component:{name:"el-input-number",props:{"controls-position":"right",min:0,max:100}}}],form:e,on:{submit(t,{done:l,close:n}){j.base.sys.department[a]({id:e.id,parentId:e.parentId,name:t.name,orderNum:t.orderNum}).then((()=>{o.success(`新增部門 “${t.name}” 成功`),n(),K()})).catch((e=>{o.error(e.message),l()}))}}})}function ae(e){e?r.confirm("部門架構已發生改變，是否保存？","提示",{type:"warning"}).then((async()=>{const e=[];!function t(a,l){a.forEach((a=>{a.parentId=l,e.push(a),a.children&&T(a.children)&&t(a.children,a.id)}))}(I.value,null),await j.base.sys.department.order(e.map(((e,t)=>({id:e.id,parentId:e.parentId,orderNum:t})))).then((()=>{o.success("更新排序成功")})).catch((e=>{o.error(e.message)})),K(),U.value=!1})).catch((()=>null)):K()}function le(e,a,l){a||(a=I.value[0]||{});const s=j.base.sys.department.permission;t.exports.ContextMenu.open(e,{list:[{label:"新增",hidden:l&&l.level>=u.level||!n(s.add),callback(e){Q({name:"",parentName:a.name,parentId:a.id}),e()}},{label:"編輯",hidden:!n(s.update),callback(e){Q(a),e()}},{label:"刪除",hidden:!a.parentId||!n(s.delete),callback(e){!function(e){async function t(t){await j.base.sys.department.delete({ids:[e.id],deleteUser:t}).then((()=>{e.id==S.value.id&&(S.value=null),t?o.success("刪除成功"):r.confirm(`“${e.name}” 部門的用戶已成功轉移到 “${e.parentName}” 部門。`,"刪除成功")})),K()}r.confirm(`該操作會刪除 “${e.name}” 部門的所有用戶，是否確認？`,"提示",{type:"warning",confirmButtonText:"直接刪除",cancelButtonText:"保留用戶",distinguishCancelAndClose:!0}).then((()=>{t(!0)})).catch((e=>{"cancel"==e&&t(!1)}))}(a),e()}},{label:"新增成員",hidden:!n(s.add),callback(e){d("user-add",a),e()}}]})}return p((function(){K()})),(e,t)=>{const a=c("el-icon"),l=c("el-tooltip"),n=c("el-button"),o=c("el-tree"),r=c("el-scrollbar"),i=c("cl-form"),d=y("loading");return m(),v("div",Y,[h("div",D,[H,h("ul",O,[h("li",{onClick:t[0]||(t[0]=e=>K())},[f(l,{content:"刷新"},{default:g((()=>[f(a,null,{default:g((()=>[f(W(R))])),_:1})])),_:1})]),s.drag&&!W(C).browser.isMini?(m(),v("li",{key:0,onClick:t[1]||(t[1]=e=>U.value=!0)},[f(l,{content:"拖動排序"},{default:g((()=>[f(a,null,{default:g((()=>[f(W(A))])),_:1})])),_:1})])):k("",!0),_(h("li",P,[f(n,{onClick:t[2]||(t[2]=e=>ae(!0)),size:"small"},{default:g((()=>[x("保存")])),_:1}),f(n,{onClick:t[3]||(t[3]=e=>ae(!1)),size:"small"},{default:g((()=>[x("取消")])),_:1})],512),[[q,U.value]])])]),h("div",{class:"dept-tree__container",onContextmenu:L(le,["stop","prevent"])},[f(r,null,{default:g((()=>[_((m(),w(o,{"node-key":"id","default-expand-all":"",data:I.value,props:{label:"name"},draggable:U.value,"allow-drag":E,"allow-drop":G,"expand-on-click-node":!1,onNodeContextmenu:le},{default:g((({node:e,data:t})=>{var l;return[h("div",Z,[h("span",{class:$(["dept-tree__node-label",{"is-active":t.id==(null==(l=S.value)?void 0:l.id)}]),onClick:e=>J(t)},B(e.label),11,ee),W(C).browser.isMini?(m(),v("span",{key:0,class:"dept-tree__node-icon",onClick:a=>le(a,t,e)},[f(a,null,{default:g((()=>[f(W(M))])),_:1})],8,te)):k("",!0)])]})),_:1},8,["data","draggable"])),[[d,V.value]])])),_:1})],40,X),f(i,{ref_key:"Form",ref:z},null,512)])}}}),[["__scopeId","data-v-87c6d1b5"]]),ne=e=>(j("data-v-2a5f1410"),e=e(),C(),e),se={style:{float:"left"}},oe={class:"flex flex-wrap justify-around space-x-4",style:{display:"flex"}},re={class:"block",style:{"margin-right":"20px"}},ie=ne((()=>h("div",{class:"text-center font-bold mb-3",style:{"margin-bottom":"2em","font-weight":"bold","text-align":"center"}}," 證件照 ",-1))),de=ne((()=>h("label",{for:"rejectReason"},"駁回原因",-1))),ue={style:{display:"flex","justify-content":"center","margin-top":"25px"}},pe=d({name:"sys-user"}),ce=z(d({...pe,setup(e){const{service:a,refs:l,setRefs:n}=i(),{dict:r}=s(),d=r.get("identityStatus"),u=U({dept:{},ids:[]}),b=I((()=>{var e;return`成員列表（${(null==(e=u.dept)?void 0:e.name)||""}）`})),j=t.exports.useCrud({service:a.base.sys.user}),C=t.exports.useTable({columns:[{type:"selection",width:60},{prop:"name",label:"姓名",minWidth:120},{prop:"username",label:"用戶名",minWidth:150},{prop:"phone",label:"手機號碼",minWidth:120},{prop:"departmentName",label:"部門",minWidth:150},{prop:"roleName",label:"角色",headerAlign:"center",minWidth:100},{prop:"status",label:"狀態",minWidth:100,dict:[{label:"正常",value:1,type:"success"},{label:"停權",value:"danger",type:"danger"}]},{prop:"emailStatus",label:"信箱驗證",minWidth:100,dict:r.get("emailStatus")},{prop:"identityStatus",label:"身份驗證",minWidth:100,dict:r.get("identityStatus")},{prop:"remark",label:"備註",minWidth:150},{prop:"createTime",label:"創建時間",sortable:"custom",minWidth:160},{type:"op",buttons:["slot-btn","edit","delete"],width:240}]}),z=N();p((async()=>{z.value=await a.base.sys.role.list()}));const q=t.exports.useUpsert({dialog:{width:"800px"},items:[{prop:"avatar",label:"頭像",component:{name:"cl-upload",props:{text:"選擇頭像"}}},{prop:"firstName",label:"姓氏",span:12,required:!0,component:{name:"el-input"}},{prop:"lastName",label:"名字",required:!0,span:12,component:{name:"el-input"}},{prop:"username",label:"用戶名",required:!0,span:12,component:{name:"el-input"}},()=>{var e;return{prop:"password",label:"密碼",span:12,required:"add"==(null==(e=q.value)?void 0:e.mode),component:{name:"el-input",props:{type:"password"}},rules:[{min:8,max:16,message:"密碼長度在 8 到 16 個字符"}]}},{prop:"gender",label:"性別",value:1,component:{name:"el-radio-group",options:r.get("userGender")}},{prop:"roleIdList",label:"角色",value:[],required:!0,component:{name:"slot-roleIdList"}},{prop:"phone",label:"手機號碼",span:12,component:{name:"el-input"}},{prop:"email",label:"郵箱",span:12,component:{name:"el-input"}},{prop:"intro",label:"簡介",component:{name:"cl-editor-wang"}},{prop:"remark",label:"備註",component:{name:"el-input",props:{type:"textarea",rows:4}}},{prop:"emailStatus",label:"信箱驗證",value:17,component:{name:"el-select",options:r.get("emailStatus")}},{prop:"identityStatus",label:"身份驗證",value:24,component:{name:"el-select",options:r.get("identityStatus")}},{prop:"status",label:"狀態",value:1,component:{name:"el-select",options:[{label:"正常",value:1},{label:"停權",value:0}]}}],onSubmit(e,{next:t}){t({...e})}});function L(e){u.ids=e.map((e=>e.id))}function R({item:e,ids:t}){var a,l;u.dept=e,a={page:1,departmentIds:t},null==(l=j.value)||l.refresh(a)}function A(e){var t;null==(t=j.value)||t.rowAppend({departmentId:e.id})}async function M(e){let t=[];t=e?[e.id]:u.ids,l.value.deptMove.open(t)}const T=N(!1),$=N({positive:"",negative:""}),F=N(""),E=N(null),G=N(null),K=N(""),J=async()=>{await a.base.sys.user.update({id:E.value,rejectReason:K.value,identityStatus:22}),T.value=!1,G.value.identityStatus=22,o.success("修改成功")};return(e,t)=>{const l=c("cl-refresh-btn"),s=c("cl-add-btn"),r=c("cl-multi-delete-btn"),i=c("el-button"),p=c("cl-flex1"),I=c("cl-search-key"),N=c("el-row"),U=c("el-tag"),Y=c("cl-table"),D=c("cl-pagination"),H=c("el-option"),O=c("el-select"),P=c("cl-upsert"),X=c("cl-crud"),Z=c("el-image"),ee=c("el-input"),te=c("cl-dialog"),ae=c("cl-view-group"),ne=y("permission");return m(),w(ae,{title:W(b)},{left:g((()=>[f(le,{onRowClick:R,onUserAdd:A})])),right:g((()=>[f(X,{ref_key:"Crud",ref:j},{default:g((()=>[f(N,null,{default:g((()=>[f(l),f(s),f(r),_((m(),w(i,{type:"success",disabled:0==u.ids.length,onClick:t[0]||(t[0]=e=>M())},{default:g((()=>[x("轉移")])),_:1},8,["disabled"])),[[ne,W(a).base.sys.user.permission.move]]),f(p),f(I)])),_:1}),f(N,null,{default:g((()=>[f(Y,{ref_key:"Table",ref:C,"default-sort":{prop:"createTime",order:"descending"},onSelectionChange:L},{"column-identityStatus":g((({scope:e})=>{var t;return[f(i,{"disable-transitions":"",size:"small",effect:"dark",style:{margin:"2px"},type:null==(t=W(d).find((t=>t.value===e.row.identityStatus)))?void 0:t.type,onClick:t=>(async e=>{G.value=e,F.value=`${e.name} - 身份驗證`,E.value=e.id;const t=await a.base.sys.user.getIdentity({userId:e.id});$.value=t,T.value=!0})(e.row)},{default:g((()=>{var t;return[x(B(null==(t=W(d).find((t=>t.value===e.row.identityStatus)))?void 0:t.label),1)]})),_:2},1032,["type","onClick"])]})),"column-roleName":g((({scope:e})=>[e.row.roleName?(m(!0),v(V,{key:0},S(e.row.roleName.split(","),((e,t)=>(m(),w(U,{key:t,"disable-transitions":"",size:"small",effect:"dark",style:{margin:"2px"}},{default:g((()=>[x(B(e),1)])),_:2},1024)))),128)):k("",!0)])),"slot-btn":g((({scope:e})=>[_((m(),w(i,{text:"",bg:"",onClick:t=>M(e.row)},{default:g((()=>[x("轉移")])),_:2},1032,["onClick"])),[[ne,W(a).base.sys.user.permission.move]])])),_:1},512)])),_:1}),f(N,null,{default:g((()=>[f(p),f(D)])),_:1}),f(P,{ref_key:"Upsert",ref:q},{"slot-roleIdList":g((({scope:e})=>[f(O,{modelValue:e.roleIdList,"onUpdate:modelValue":t=>e.roleIdList=t,multiple:!0,"multiple-limit":1,disabled:e.roleIdList.includes(11),placeholder:"請選擇"},{default:g((()=>[(m(!0),v(V,null,S(z.value,(e=>(m(),w(H,{key:e.id,label:e.name,value:e.id},{default:g((()=>[h("span",se,B(e.name),1)])),_:2},1032,["label","value"])))),128))])),_:2},1032,["modelValue","onUpdate:modelValue","disabled"])])),_:1},512),f(Q,{ref:W(n)("deptMove")},null,512)])),_:1},512),f(te,{title:F.value,width:"600px",height:"100%",modelValue:T.value,"onUpdate:modelValue":t[4]||(t[4]=e=>T.value=e)},{default:g((()=>{var e;return[h("div",oe,[h("div",re,[ie,f(Z,{style:{"max-width":"600px"},src:null==(e=$.value)?void 0:e.positive,fit:"contain"},null,8,["src"])])]),h("div",null,[de,f(ee,{id:"rejectReason",modelValue:K.value,"onUpdate:modelValue":t[1]||(t[1]=e=>K.value=e)},null,8,["modelValue"])]),h("div",ue,[f(i,{onClick:t[2]||(t[2]=e=>(async()=>{await a.base.sys.user.identityAgree({userId:E.value}),G.value.identityStatus=23,T.value=!1,o.success("修改成功")})()),type:"success"},{default:g((()=>[x("同意")])),_:1}),f(i,{onClick:J,type:"danger"},{default:g((()=>[x("駁回")])),_:1}),f(i,{onClick:t[3]||(t[3]=e=>T.value=!1)},{default:g((()=>[x("取消")])),_:1})])]})),_:1},8,["title","modelValue"])])),_:1},8,["title"])}}}),[["__scopeId","data-v-2a5f1410"]]);export{ce as default};
