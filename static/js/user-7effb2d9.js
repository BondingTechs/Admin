import{d as e,i as t,u as a,r as l,e as n,f as s}from"./index-20a0cf21.js";import"./vue-echarts-f79e68f9.js";import{a as o,b as r}from"./element-plus-ad41b746.js";import"./store-96e17a43.js";import{u as i}from"./index-ad92c18b.js";import{d,p,e as u,R as c,o as m,c as v,b,y as f,Y as h,a as y,J as g,M as k,K as x,N as _,I as w,al as j,ak as C,q as I,V as S,F as V}from"./@vue.runtime-core-e50a2272.js";import{e as N,u as W,h as U}from"./@vue.reactivity-da630c06.js";import{_ as z}from"./_plugin-vue_export-helper-c4cb8a60.js";import{v as q,w as R}from"./@vue.runtime-dom-90e9fdb1.js";import{Q as M,R as T,E as $}from"./@element-plus.icons-vue-26cbeb7a.js";import{j as A}from"./lodash-es-a085e596.js";import{o as B,L as F}from"./@vue.shared-5670d8a7.js";import"./axios-966d6f38.js";import"./nprogress-6d1393d1.js";import"./vue-router-916993ce.js";import"./pinia-bb8d2f73.js";import"./vue-demi-5b9a0fa5.js";import"./@vueuse.core-2fa6d9e6.js";import"./@vueuse.shared-ca6b0f06.js";import"./vue-b5fce9d1.js";import"./mockjs-93ca2bc8.js";import"./mitt-dab1f1cb.js";import"./@popperjs.core-040feab9.js";import"./@ctrl.tinycolor-84ad98d6.js";import"./dayjs-dd470533.js";import"./async-validator-efc2d198.js";import"./memoize-one-99e54574.js";import"./escape-html-4bbaf1e1.js";import"./normalize-wheel-es-da779ce4.js";import"./@floating-ui.dom-9d85c32a.js";import"./@floating-ui.core-c56fb7e8.js";import"./resize-detector-94afada7.js";import"./echarts-6943293a.js";import"./tslib-ed971494.js";import"./zrender-0d232395.js";const E={class:"dept-select"},L=d({name:"dept-select"}),K=z(d({...L,props:{modelValue:[Array,Number,String],multiple:Boolean,checkStrictly:{type:Boolean,default:!0}},emits:["update:modelValue","change"],setup(t,{emit:a}){const l=t,{service:n}=i(),s=N(),r=N();function d(e){l.multiple||a("update:modelValue",e)}function f(e,{checkedKeys:t}){l.multiple&&a("update:modelValue",t)}return p((()=>l.modelValue),(e=>{s.value=e}),{immediate:!0}),u((()=>{n.base.sys.department.list().then((t=>{r.value=e(t)})).catch((e=>{r.value=[],o.error(e.message)}))})),(e,a)=>{const l=c("el-tree-select");return m(),v("div",E,[b(l,{modelValue:s.value,"onUpdate:modelValue":a[0]||(a[0]=e=>s.value=e),"node-key":"id",data:r.value,props:{label:"name",value:"id",children:"children"},multiple:t.multiple,"check-strictly":t.checkStrictly,"show-checkbox":t.multiple,"default-expand-all":"",onChange:d,onCheck:f},null,8,["modelValue","data","multiple","check-strictly","show-checkbox"])])}}}),[["__scopeId","data-v-6be59c9b"]]),O={class:"dept-move"},G=d({name:"dept-move"}),J=d({...G,setup(e,{expose:a}){const{service:l}=i(),n=t.exports.useForm(),s=t.exports.useCrud();return a({open:async function(e){var t;null==(t=n.value)||t.open({title:"部門轉移",width:"600px",props:{labelWidth:"80px"},items:[{label:"選擇部門",prop:"departmentId",component:{vm:K}}],on:{submit(t,{done:a,close:n}){if(!t.departmentId)return o.warning("請選擇部門"),a();r.confirm("是否轉移部門？","提示",{type:"warning"}).then((()=>{l.base.sys.user.move({...t,userIds:e}).then((()=>{var e;o.success("轉移成功"),null==(e=s.value)||e.refresh(),n()})).catch((e=>{o.error(e.message),a()}))})).catch((()=>null))}}})}}),(e,t)=>{const a=c("cl-form");return m(),v("div",O,[b(a,{ref_key:"Form",ref:n},null,512)])}}}),Q={class:"dept-tree"},Y={class:"dept-tree__header"},D=(e=>(j("data-v-87c6d1b5"),e=e(),C(),e))((()=>y("div",null,"組織架構",-1))),H={class:"dept-tree__op"},P={class:"no"},X=["onContextmenu"],Z={class:"dept-tree__node"},ee=["onClick"],te=["onClick"],ae=d({name:"dept-tree"}),le=z(d({...ae,props:{drag:{type:Boolean,default:!0},level:{type:Number,default:99}},emits:["list-change","row-click","user-add"],setup(s,{emit:d}){const p=s,{service:j}=i(),{app:C}=a(),I=N([]),S=N(),V=N(!1),U=N(!1),z=t.exports.useForm(),E=f("viewGroup");function L({data:e}){return e.parentId}function K(e,t){return t.data.parentId}async function O(){V.value=!0,U.value=!1,await j.base.sys.department.list().then((t=>{I.value=e(t),S.value||(S.value=I.value[0]),G(S.value)})),V.value=!1}function G(e){if(e){const t=e.children?l(e.children).map((e=>e.id)):[];t.unshift(e.id),S.value=e,E.checkExpand(!1),d("row-click",{item:e,ids:t})}}function J(e){var t;const a=e.id?"update":"add";null==(t=z.value)||t.open({title:"編輯部門",width:"550px",props:{labelWidth:"100px"},items:[{label:"部門名稱",prop:"name",component:{name:"el-input"},required:!0},{label:"上級部門",prop:"parentName",component:{name:"el-input",props:{disabled:!0}}},{label:"排序",prop:"orderNum",component:{name:"el-input-number",props:{"controls-position":"right",min:0,max:100}}}],form:e,on:{submit(t,{done:l,close:n}){j.base.sys.department[a]({id:e.id,parentId:e.parentId,name:t.name,orderNum:t.orderNum}).then((()=>{o.success(`新增部門 “${t.name}” 成功`),n(),O()})).catch((e=>{o.error(e.message),l()}))}}})}function ae(e){e?r.confirm("部門架構已發生改變，是否保存？","提示",{type:"warning"}).then((async()=>{const e=[];!function t(a,l){a.forEach((a=>{a.parentId=l,e.push(a),a.children&&A(a.children)&&t(a.children,a.id)}))}(I.value,null),await j.base.sys.department.order(e.map(((e,t)=>({id:e.id,parentId:e.parentId,orderNum:t})))).then((()=>{o.success("更新排序成功")})).catch((e=>{o.error(e.message)})),O(),U.value=!1})).catch((()=>null)):O()}function le(e,a,l){a||(a=I.value[0]||{});const s=j.base.sys.department.permission;t.exports.ContextMenu.open(e,{list:[{label:"新增",hidden:l&&l.level>=p.level||!n(s.add),callback(e){J({name:"",parentName:a.name,parentId:a.id}),e()}},{label:"編輯",hidden:!n(s.update),callback(e){J(a),e()}},{label:"刪除",hidden:!a.parentId||!n(s.delete),callback(e){!function(e){async function t(t){await j.base.sys.department.delete({ids:[e.id],deleteUser:t}).then((()=>{e.id==S.value.id&&(S.value=null),t?o.success("刪除成功"):r.confirm(`“${e.name}” 部門的用戶已成功轉移到 “${e.parentName}” 部門。`,"刪除成功")})),O()}r.confirm(`該操作會刪除 “${e.name}” 部門的所有用戶，是否確認？`,"提示",{type:"warning",confirmButtonText:"直接刪除",cancelButtonText:"保留用戶",distinguishCancelAndClose:!0}).then((()=>{t(!0)})).catch((e=>{"cancel"==e&&t(!1)}))}(a),e()}},{label:"新增成員",hidden:!n(s.add),callback(e){d("user-add",a),e()}}]})}return u((function(){O()})),(e,t)=>{const a=c("el-icon"),l=c("el-tooltip"),n=c("el-button"),o=c("el-tree"),r=c("el-scrollbar"),i=c("cl-form"),d=h("loading");return m(),v("div",Q,[y("div",Y,[D,y("ul",H,[y("li",{onClick:t[0]||(t[0]=e=>O())},[b(l,{content:"刷新"},{default:g((()=>[b(a,null,{default:g((()=>[b(W(M))])),_:1})])),_:1})]),s.drag&&!W(C).browser.isMini?(m(),v("li",{key:0,onClick:t[1]||(t[1]=e=>U.value=!0)},[b(l,{content:"拖動排序"},{default:g((()=>[b(a,null,{default:g((()=>[b(W(T))])),_:1})])),_:1})])):k("",!0),x(y("li",P,[b(n,{onClick:t[2]||(t[2]=e=>ae(!0)),size:"small"},{default:g((()=>[_("保存")])),_:1}),b(n,{onClick:t[3]||(t[3]=e=>ae(!1)),size:"small"},{default:g((()=>[_("取消")])),_:1})],512),[[q,U.value]])])]),y("div",{class:"dept-tree__container",onContextmenu:R(le,["stop","prevent"])},[b(r,null,{default:g((()=>[x((m(),w(o,{"node-key":"id","default-expand-all":"",data:I.value,props:{label:"name"},draggable:U.value,"allow-drag":L,"allow-drop":K,"expand-on-click-node":!1,onNodeContextmenu:le},{default:g((({node:e,data:t})=>{var l;return[y("div",Z,[y("span",{class:B(["dept-tree__node-label",{"is-active":t.id==(null==(l=S.value)?void 0:l.id)}]),onClick:e=>G(t)},F(e.label),11,ee),W(C).browser.isMini?(m(),v("span",{key:0,class:"dept-tree__node-icon",onClick:a=>le(a,t,e)},[b(a,null,{default:g((()=>[b(W($))])),_:1})],8,te)):k("",!0)])]})),_:1},8,["data","draggable"])),[[d,V.value]])])),_:1})],40,X),b(i,{ref_key:"Form",ref:z},null,512)])}}}),[["__scopeId","data-v-87c6d1b5"]]),ne=e=>(j("data-v-05b583eb"),e=e(),C(),e),se={class:"flex flex-wrap justify-around space-x-4",style:{display:"flex"}},oe={class:"block",style:{"margin-right":"20px"}},re=ne((()=>y("div",{class:"text-center font-bold mb-3",style:{"margin-bottom":"2em","font-weight":"bold","text-align":"center"}}," 證件照 ",-1))),ie=ne((()=>y("label",{for:"rejectReason"},"駁回原因",-1))),de={style:{display:"flex","justify-content":"center","margin-top":"25px"}},pe=d({name:"sys-user"}),ue=z(d({...pe,setup(e){const{service:a,refs:l,setRefs:n}=i(),{dict:r}=s(),d=r.get("identityStatus"),p=U({dept:{},ids:[]}),u=I((()=>{var e;return`成員列表（${(null==(e=p.dept)?void 0:e.name)||""}）`})),f=t.exports.useCrud({service:a.base.sys.user}),j=t.exports.useTable({columns:[{type:"selection",width:60},{prop:"name",label:"姓名",minWidth:120},{prop:"username",label:"用戶名",minWidth:150},{prop:"phone",label:"手機號碼",minWidth:120},{prop:"departmentName",label:"部門",minWidth:150},{prop:"roleName",label:"角色",headerAlign:"center",minWidth:100},{prop:"status",label:"狀態",minWidth:100,dict:[{label:"正常",value:1,type:"success"},{label:"停權",value:"danger",type:"danger"}]},{prop:"emailStatus",label:"信箱驗證",minWidth:100,dict:r.get("emailStatus")},{prop:"identityStatus",label:"身份驗證",minWidth:100,dict:r.get("identityStatus")},{prop:"remark",label:"備註",minWidth:150},{prop:"createTime",label:"創建時間",sortable:"custom",minWidth:160},{type:"op",buttons:["slot-btn","edit","delete"],width:240}]}),C=t.exports.useUpsert({dialog:{width:"800px"},items:[{prop:"avatar",label:"頭像",component:{name:"slot-upload",props:{text:"選擇頭像"}}},{prop:"firstName",label:"姓氏",span:12,required:!0,component:{name:"el-input"}},{prop:"lastName",label:"名字",required:!0,span:12,component:{name:"el-input"}},{prop:"username",label:"用戶名",required:!0,span:12,component:{name:"el-input"}},()=>{var e;return{prop:"password",label:"密碼",span:12,required:"add"==(null==(e=C.value)?void 0:e.mode),component:{name:"el-input",props:{type:"password"}},rules:[{min:8,max:16,message:"密碼長度在 8 到 16 個字符"}]}},{prop:"gender",label:"性別",value:1,component:{name:"el-radio-group",options:[{label:"男",value:1},{label:"女",value:0}]}},{prop:"roleIdList",label:"角色",value:[],required:!0,component:{name:"el-select",options:[],props:{multiple:!0,"multiple-limit":1}}},{prop:"phone",label:"手機號碼",span:12,component:{name:"el-input"}},{prop:"email",label:"郵箱",span:12,component:{name:"el-input"}},{prop:"intro",label:"簡介",component:{name:"cl-editor-wang"}},{prop:"remark",label:"備註",component:{name:"el-input",props:{type:"textarea",rows:4}}},{prop:"emailStatus",label:"信箱驗證",component:{name:"el-select",options:r.get("emailStatus")}},{prop:"identityStatus",label:"身份驗證",component:{name:"el-select",options:r.get("identityStatus")}},{prop:"status",label:"狀態",value:1,component:{name:"el-select",options:[{label:"正常",value:1},{label:"停權",value:0}]}}],onSubmit(e,{next:t}){var a;t({...e,departmentId:null==(a=p.dept)?void 0:a.id})},async onOpen(){var e;const t=await a.base.sys.role.list();null==(e=C.value)||e.setOptions("roleIdList",t.map((e=>({label:e.name||"",value:e.id}))))}});function z(e){p.ids=e.map((e=>e.id))}function q({item:e,ids:t}){var a,l;p.dept=e,a={page:1,departmentIds:t},null==(l=f.value)||l.refresh(a)}function R(e){var t;null==(t=f.value)||t.rowAppend({departmentId:e.id})}async function M(e){let t=[];t=e?[e.id]:p.ids,l.value.deptMove.open(t)}const T=N(!1),$=N({positive:"",negative:""}),A=N(""),B=N(null),E=N(null),L=N(""),K=async()=>{await a.base.sys.user.update({id:B.value,rejectReason:L.value,identityStatus:22}),T.value=!1,E.value.identityStatus=22,o.success("修改成功")};return(e,t)=>{const l=c("cl-refresh-btn"),s=c("cl-add-btn"),r=c("cl-multi-delete-btn"),i=c("el-button"),I=c("cl-flex1"),N=c("cl-search-key"),U=c("el-row"),O=c("el-tag"),G=c("cl-table"),Q=c("cl-pagination"),Y=c("cl-upload"),D=c("cl-upsert"),H=c("cl-crud"),P=c("el-image"),X=c("el-input"),Z=c("cl-dialog"),ee=c("cl-view-group"),te=h("permission");return m(),w(ee,{title:W(u)},{left:g((()=>[b(le,{onRowClick:q,onUserAdd:R})])),right:g((()=>[b(H,{ref_key:"Crud",ref:f},{default:g((()=>[b(U,null,{default:g((()=>[b(l),b(s),b(r),x((m(),w(i,{type:"success",disabled:0==p.ids.length,onClick:t[0]||(t[0]=e=>M())},{default:g((()=>[_("轉移")])),_:1},8,["disabled"])),[[te,W(a).base.sys.user.permission.move]]),b(I),b(N)])),_:1}),b(U,null,{default:g((()=>[b(G,{ref_key:"Table",ref:j,"default-sort":{prop:"createTime",order:"descending"},onSelectionChange:z},{"column-identityStatus":g((({scope:e})=>{var t;return[b(i,{"disable-transitions":"",size:"small",effect:"dark",style:{margin:"2px"},type:null==(t=W(d).find((t=>t.value===e.row.identityStatus)))?void 0:t.type,onClick:t=>(async e=>{E.value=e,A.value=`${e.name} - 身份驗證`,B.value=e.id;const t=await a.base.sys.user.getIdentity({userId:e.id});$.value=t,T.value=!0})(e.row)},{default:g((()=>{var t;return[_(F(null==(t=W(d).find((t=>t.value===e.row.identityStatus)))?void 0:t.label),1)]})),_:2},1032,["type","onClick"])]})),"column-roleName":g((({scope:e})=>[e.row.roleName?(m(!0),v(V,{key:0},S(e.row.roleName.split(","),((e,t)=>(m(),w(O,{key:t,"disable-transitions":"",size:"small",effect:"dark",style:{margin:"2px"}},{default:g((()=>[_(F(e),1)])),_:2},1024)))),128)):k("",!0)])),"slot-btn":g((({scope:e})=>[x((m(),w(i,{text:"",bg:"",onClick:t=>M(e.row)},{default:g((()=>[_("轉移")])),_:2},1032,["onClick"])),[[te,W(a).base.sys.user.permission.move]])])),_:1},512)])),_:1}),b(U,null,{default:g((()=>[b(I),b(Q)])),_:1}),b(D,{ref_key:"Upsert",ref:C},{"slot-upload":g((({scope:e})=>[_(" test "),b(Y,{modelValue:e.avatar,"onUpdate:modelValue":t=>e.avatar=t},null,8,["modelValue","onUpdate:modelValue"])])),_:1},512),b(J,{ref:W(n)("deptMove")},null,512)])),_:1},512),b(Z,{title:A.value,width:"600px",height:"100%",modelValue:T.value,"onUpdate:modelValue":t[4]||(t[4]=e=>T.value=e)},{default:g((()=>{var e;return[y("div",se,[y("div",oe,[re,b(P,{style:{"max-width":"600px"},src:null==(e=$.value)?void 0:e.positive,fit:"contain"},null,8,["src"])])]),y("div",null,[ie,b(X,{id:"rejectReason",modelValue:L.value,"onUpdate:modelValue":t[1]||(t[1]=e=>L.value=e)},null,8,["modelValue"])]),y("div",de,[b(i,{onClick:t[2]||(t[2]=e=>(async()=>{await a.base.sys.user.update({id:B.value,identityStatus:23}),E.value.identityStatus=23,T.value=!1,o.success("修改成功")})()),type:"success"},{default:g((()=>[_("同意")])),_:1}),b(i,{onClick:K,type:"danger"},{default:g((()=>[_("駁回")])),_:1}),b(i,{onClick:t[3]||(t[3]=e=>T.value=!1)},{default:g((()=>[_("取消")])),_:1})])]})),_:1},8,["title","modelValue"])])),_:1},8,["title"])}}}),[["__scopeId","data-v-05b583eb"]]);export{ue as default};
