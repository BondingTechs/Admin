import{l as e,v as a,w as s}from"./@vue.runtime-dom-90e9fdb1.js";import{u as t,i as o,m as l,k as r,l as i}from"./index-d2d8fdcb.js";import{J as d,u as p,P as u}from"./@element-plus.icons-vue-26cbeb7a.js";import{d as n}from"./dayjs-dd470533.js";import{D as c}from"./vuedraggable-4149a334.js";import{f as m,a as f,b as g}from"./index-0074aea4.js";import"./vue-echarts-f79e68f9.js";import{a as v}from"./element-plus-ad41b746.js";import{u as b}from"./index-9592a997.js";import{j as h,v as y}from"./lodash-es-a085e596.js";import{d as j,q as _,t as w,p as k,R as x,o as z,c as S,a as U,b as $,J as V,E as B,I as C,M as F,G as L,F as A,N as D,K as I}from"./@vue.runtime-core-e50a2272.js";import{e as R,h as q,u as O}from"./@vue.reactivity-da630c06.js";import{o as P,L as M}from"./@vue.shared-5670d8a7.js";import{_ as E}from"./_plugin-vue_export-helper-c4cb8a60.js";import"./store-96e17a43.js";import"./axios-966d6f38.js";import"./nprogress-6d1393d1.js";import"./vue-router-916993ce.js";import"./pinia-bb8d2f73.js";import"./vue-demi-5b9a0fa5.js";import"./@vueuse.core-2fa6d9e6.js";import"./@vueuse.shared-ca6b0f06.js";import"./vue-b5fce9d1.js";import"./mockjs-93ca2bc8.js";import"./mitt-dab1f1cb.js";import"./@popperjs.core-040feab9.js";import"./@ctrl.tinycolor-84ad98d6.js";import"./async-validator-efc2d198.js";import"./memoize-one-99e54574.js";import"./escape-html-4bbaf1e1.js";import"./normalize-wheel-es-da779ce4.js";import"./@floating-ui.dom-9d85c32a.js";import"./@floating-ui.core-c56fb7e8.js";import"./resize-detector-94afada7.js";import"./echarts-6943293a.js";import"./tslib-ed971494.js";import"./zrender-0d232395.js";import"./sortablejs-9236fa87.js";const N={class:"cl-upload__wrap"},Y={class:"cl-upload__header"},K={key:0,class:"cl-upload__item"},G={class:"cl-upload__text"},J={key:1,class:"cl-upload__btn"},T={class:"cl-upload__name"},H={class:"cl-upload__size"},Q={class:"cl-upload__actions"},W=["onClick"],X=["onClick"],Z={key:2,class:"cl-upload__progress"},ee={key:3,class:"cl-upload__error"},ae=["src"],se=j({name:"cl-upload"}),te=E(j({...se,props:{modelValue:{type:[String,Array],default:()=>[]},type:{type:String,default:"image"},accept:String,multiple:Boolean,limit:Number,limitSize:Number,size:[String,Number,Array],text:String,prefixPath:{type:String,default:"app"},showFileList:{type:Boolean,default:!0},drag:Boolean,disabled:Boolean,isEdit:null,scope:null},emits:["update:modelValue","upload","success","error","progress"],setup(j,{expose:E,emit:se}){const te=j;e((e=>({"4a40132d":O(pe)[0],"4a40134c":O(pe)[1]})));const{service:oe}=b(),{user:le}=t(),re=o.exports.useForm(),{options:ie}=l.get("upload"),de=R(),pe=_((()=>{const e=te.size||ie.size;return(h(e)?e:[e,e]).map((e=>y(e)?e+"px":e))})),ue=_((()=>{var e;return(null==(e=re.value)?void 0:e.disabled)||te.disabled})),ne=te.limit||ie.limit.upload,ce=te.limitSize||ie.limit.size,me=te.text||ie.text,fe=_((()=>({Authorization:le.token}))),ge=q({visible:!1,url:""}),ve=R([]),be=q({options:{group:"Upload",animation:300,ghostClass:"Ghost",dragClass:"Drag",draggable:".is-drag",disabled:!te.drag}}),he=_((()=>te.accept||("file"==te.type?"*":"image/*"))),ye=_((()=>te.multiple?ne-ve.value.length>0:0==ve.value.length));function je(e){return"image"==te.type?"image":m(e).value}R(null);async function _e(e,a){if(e.size/1024/1024>=ce)return v.error(`上傳文件大小不能超過 ${ce}MB!`),!1;const s={type:je(e.name),preload:"",progress:0,url:"",uid:e.uid,size:e.size};return s.preload="image"==s.type?window.webkitURL.createObjectURL(e):e.name,a?Object.assign(a,s):ye.value?ve.value.push(s):ve.value=[s],se("upload",s),!0}function we(e){ve.value.splice(e,1),Se()}function ke(){ve.value=[]}async function xe(e,a){const s=e.file,t=1024,o=1024,l=s.size/1024/1024;if(a||(a=ve.value.find((a=>a.uid==e.file.uid))),l<1)ze(s,a);else{const e=new FileReader;e.onload=e=>{const l=new Image;l.onload=()=>{const e=document.createElement("canvas"),r=e.getContext("2d");let i=l.width,d=l.height;i>d?i>t&&(d*=t/i,i=t):d>o&&(i*=o/d,d=o),e.width=i,e.height=d,r.drawImage(l,0,0,i,d),e.toBlob((async e=>{const t=URL.createObjectURL(e),o=await async function(e,a){try{const s=await fetch(e),t=await s.blob();return new File([t],a,{type:t.type})}catch(s){return null}}(t,s.name);ze(o,a)}),s.type)},l.src=e.target.result},e.readAsDataURL(s)}}async function ze(e,a){try{const s=e.name.split(".").pop();let t=`${r()}.${s}`;const{mode:o,type:l}=await oe.base.comm.uploadMode();return new Promise(((s,r)=>{async function i({host:l,preview:i,data:d}){const p=new FormData;for(const e in d)p.append(e,d[e]);"cloud"==o&&(t=[te.prefixPath,n().format("YYYY-MM-DD"),t].filter(Boolean).join("/")),p.append("key",t),p.append("file",e),await oe.request({url:l,method:"POST",headers:{"Content-Type":"multipart/form-data"},timeout:6e5,data:p,onUploadProgress(e){a.progress=parseInt(String(e.loaded/e.total*100)),se("progress",a)},proxy:"local"==o}).then((e=>{a.url="local"===o?e:`${i||l}/${t}`,se("success",a),s(a.url),Se()})).catch((e=>{v.error(e.message),a.error=e.message,se("error",a),r(e)}))}"local"==o?i({host:"/admin/base/comm/upload"}):oe.base.comm.upload().then((e=>{switch(l){case"cos":i({host:e.url,data:e.credentials});break;case"oss":i({host:e.host,data:{OSSAccessKeyId:e.OSSAccessKeyId,policy:e.policy,signature:e.signature}});break;case"qiniu":i({host:e.uploadUrl,preview:e.publicDomain,data:{token:e.token}})}})).catch(r)}))}catch(s){v.error("上傳配置錯誤")}}function Se(){ve.value.find((e=>!e.url))||se("update:modelValue",ve.value.map((e=>e.url)).join(","))}return w((()=>{})),k((()=>te.modelValue),(e=>{const a=(h(e)?e:(e||"").split(",")).filter(Boolean);ve.value=a.map((e=>{const a=ve.value.find((a=>e==a.url));return a||{type:je(e),progress:0,uid:r(),url:e,preload:e}})).filter(((e,a)=>!!te.multiple||0==a))}),{immediate:!0}),E({isAdd:ye,list:ve,check:function(){return ve.value.find((e=>100!=e.progress))},clear:ke,remove:we,upload(e){ke(),de.value.clearFiles(),de.value.handleStart(e),de.value.submit()}}),(e,t)=>{const o=x("el-icon"),l=x("el-button"),r=x("el-upload"),n=x("el-image"),m=x("el-progress"),v=x("cl-dialog");return z(),S(A,null,[U("div",N,[U("div",{class:P(["cl-upload",[`cl-upload--${j.type}`,{"is-slot":e.$slots.default,"is-custom":e.$slots.item,"is-disabled":O(ue)}]])},[U("div",Y,[$(r,{ref_key:"Upload",ref:de,action:"",accept:O(he),"show-file-list":!1,"before-upload":_e,"http-request":xe,headers:O(fe),multiple:j.multiple,disabled:O(ue)},{default:V((()=>[B(e.$slots,"default",{},(()=>["image"==j.type&&O(ye)?(z(),S("div",K,[$(o,{size:24},{default:V((()=>[$(O(d))])),_:1}),U("span",G,M(O(me)),1)])):F("",!0),"file"==j.type?(z(),S("div",J,[$(l,{type:"success"},{default:V((()=>[D(M(O(me)),1)])),_:1})])):F("",!0)]),!0)])),_:3},8,["accept","headers","multiple","disabled"])]),$(O(c),L({modelValue:ve.value,"onUpdate:modelValue":t[0]||(t[0]=e=>ve.value=e)},be.options,{"item-key":"uid",tag:"div",class:"cl-upload__list",onEnd:Se}),{item:V((({element:t,index:l})=>[j.showFileList?(z(),C(r,{key:0,action:"",class:"is-drag",accept:O(he),"show-file-list":!1,"http-request":e=>xe(e,t),"before-upload":e=>{_e(e,t)},headers:O(fe),disabled:O(ue)},{default:V((()=>[B(e.$slots,"item",{item:t,index:l},(()=>[U("div",{class:P(["cl-upload__item",[`is-${t.type}`]])},["image"==t.type?(z(),C(n,{key:0,src:t.preload,fit:"cover"},null,8,["src"])):(z(),S(A,{key:1},[U("span",T,M(O(f)(t.preload))+"."+M(O(i)(t.preload)),1),U("span",H,M(O(g)(t.size)),1)],64)),U("div",Q,[I(U("span",{onClick:s((e=>function(e){"image"==e.type?(ge.visible=!0,ge.url=e.url):window.open(e.url)}(t)),["stop"])},[$(o,null,{default:V((()=>[$(O(p))])),_:1})],8,W),[[a,t.url]]),O(ue)?F("",!0):(z(),S("span",{key:0,onClick:s((e=>we(l)),["stop"])},[$(o,null,{default:V((()=>[$(O(u))])),_:1})],8,X))]),t.progress>0&&t.progress<100?(z(),S("div",Z,[$(m,{percentage:t.progress,"show-text":!1},null,8,["percentage"])])):F("",!0),t.error?(z(),S("div",ee,M(t.error),1)):F("",!0)],2)]),!0)])),_:2},1032,["accept","http-request","before-upload","headers","disabled"])):F("",!0)])),_:3},16,["modelValue"])],2)]),$(v,{modelValue:ge.visible,"onUpdate:modelValue":t[1]||(t[1]=e=>ge.visible=e),title:"預覽",width:"500px"},{default:V((()=>[U("img",{style:{width:"100%"},src:ge.url},null,8,ae)])),_:1},8,["modelValue"])],64)}}}),[["__scopeId","data-v-94cc7d62"]]);export{te as default};
